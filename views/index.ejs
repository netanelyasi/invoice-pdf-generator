<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        .card-hover { transition: transform .2s ease; }
        .card-hover:hover { transform: translateY(-2px); }
        .muted { color: #6c757d; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">📄 מחולל חשבוניות</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/docs">תיעוד API</a>
                <a class="nav-link" href="/templates">תבניות</a>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <section class="py-4 bg-body-tertiary border-bottom">
        <div class="container d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
                <h1 class="h3 fw-bold mb-1">לוח בקרה – מחולל PDF</h1>
                <div class="muted">נהל תבניות, צור PDF מתבנית או ישירות מ‑HTML</div>
            </div>
            <div class="d-flex gap-2">
                <a href="/templates" class="btn btn-outline-secondary"><i class="bi bi-layout-text-window me-1"></i>ניהול תבניות</a>
                <a href="/templates/designer" class="btn btn-primary"><i class="bi bi-pencil-square me-1"></i>עורך תבניות</a>
                <div class="form-check form-switch d-flex align-items-center ms-2">
                  <input class="form-check-input" type="checkbox" id="themeToggle">
                  <label class="form-check-label ms-2" for="themeToggle">מצב כהה</label>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Content -->
    <section class="py-4">
        <div class="container">
            <!-- Stats -->
            <div class="row g-3 mb-3">
                <div class="col-md-3 col-sm-6">
                    <div class="card card-hover h-100">
                        <div class="card-body">
                            <div class="muted small">בריאות שירות</div>
                            <div id="statHealth" class="h5 mb-1">—</div>
                            <div class="muted small mono" id="statHealthTime">—</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card card-hover h-100">
                        <div class="card-body">
                            <div class="muted small">מס׳ תבניות</div>
                            <div id="statTemplates" class="h5 mb-1">—</div>
                            <a href="/templates" class="small">לרשימת התבניות</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card card-hover h-100">
                        <div class="card-body">
                            <div class="muted small">API Base</div>
                            <div id="statApiBase" class="text-truncate mono">—</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card card-hover h-100">
                        <div class="card-body">
                            <div class="muted small">פעולות מהירות</div>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                <a href="/templates/designer" class="btn btn-sm btn-primary">עורך</a>
                                <a href="/templates" class="btn btn-sm btn-outline-secondary">תבניות</a>
                                <button class="btn btn-sm btn-outline-primary" onclick="quickSamplePdf()">PDF לדוגמה</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <!-- Quick Generate from Template -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-body"><strong>יצירת PDF מתבנית</strong></div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label">תבנית</label>
                                    <select id="qTemplate" class="form-select">
                                        <option value="receipt">receipt</option>
                                        <option value="tax_invoice">tax_invoice</option>
                                        <option value="exempt_business_receipt">exempt_business_receipt</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">שם לקוח</label>
                                    <input id="qName" class="form-control" value="ישראל ישראלי" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">סכום</label>
                                    <input id="qTotal" type="number" class="form-control" value="150" step="0.01" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">תיאור פריט</label>
                                    <input id="qDesc" class="form-control" value="שירות מקצועי" />
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-body d-flex gap-2">
                            <button class="btn btn-primary" onclick="submitTemplatePdf()"><i class="bi bi-file-earmark-pdf me-1"></i>יצירת PDF</button>
                            <button class="btn btn-outline-secondary" onclick="openPreview()"><i class="bi bi-eye me-1"></i>תצוגה מקדימה</button>
                        </div>
                    </div>
                </div>

                <!-- HTML to PDF -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-body"><strong>HTML → PDF</strong></div>
                        <div class="card-body">
                            <textarea id="qHtml" class="form-control mono" rows="8" placeholder="<!DOCTYPE html>\n<html lang=\"he\" dir=\"rtl\">...</html>"></textarea>
                            <div class="form-text">מדביקים HTML מלא ולוחצים יצירת PDF</div>
                        </div>
                        <div class="card-footer bg-body d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="submitHtmlPdf()"><i class="bi bi-file-earmark-pdf me-1"></i>יצירת PDF</button>
                            <button class="btn btn-outline-secondary" onclick="loadHtmlSample()">טען דוגמת HTML</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Templates List & API Settings -->
            <div class="row g-3 mt-1">
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-header bg-body"><strong>תבניות זמינות</strong></div>
                        <div class="list-group list-group-flush" id="templateList"></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-body"><strong>הגדרות API (נשמר מקומית)</strong></div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label">API Base</label>
                                <input id="apiBase" class="form-control" placeholder="http://localhost:3000" />
                            </div>
                            <div class="mb-2">
                                <label class="form-label">API Key</label>
                                <input id="apiKey" class="form-control" placeholder="x-api-key" />
                            </div>
                            <button class="btn btn-outline-success" onclick="savePrefs()">שמור</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Start Section -->
    <section class="py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center mb-5">
                    <h2 class="fw-bold">תחילת עבודה מהירה</h2>
                    <p class="text-muted">התחילו להשתמש ב-API תוך דקות</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">🚀 קריאת API פשוטה</h5>
                            <p class="card-text">יצירת חשבונית PDF בקריאת POST אחת:</p>
                            <div class="api-example p-3 rounded">
                                <small class="text-muted d-block mb-2">POST <%= apiEndpoint %></small>
                                <pre class="mb-0"><code>{
  "templateType": "receipt",
  "customer": {
    "name": "John Doe",
    "email": "john@example.com"
  },
  "items": [{
    "description": "Consulting Service",
    "quantity": 1,
    "rate": 150.00,
    "amount": 150.00
  }],
  "total": 150.00
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">📋 תבניות זמינות</h5>
                            <p class="card-text">בחרו מבין התבניות המקצועיות שלנו:</p>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                     <span class="badge bg-primary me-2">receipt</span>
                                     קבלה עסקית סטנדרטית
                                </li>
                                <li class="mb-2">
                                     <span class="badge bg-danger me-2">tax_invoice</span>
                                     חשבונית מס תואמת מס
                                </li>
                                <li class="mb-2">
                                     <span class="badge bg-success me-2">exempt_business_receipt</span>
                                     קבלה לעוסק/עסקה פטורה ממס
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- API Endpoints Section -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center mb-5">
                    <h2 class="fw-bold">API Endpoints</h2>
                    <p class="text-muted">RESTful API for all your invoice needs</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <strong>POST</strong> /api/generate-pdf
                        </div>
                        <div class="card-body">
                            <p class="card-text">Generate a PDF invoice or receipt</p>
                            <small class="text-muted">Returns: PDF file download</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <strong>GET</strong> /api/templates
                        </div>
                        <div class="card-body">
                            <p class="card-text">List all available templates</p>
                            <small class="text-muted">Returns: JSON array of template names</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <strong>POST</strong> /api/preview
                        </div>
                        <div class="card-body">
                            <p class="card-text">Preview template as HTML</p>
                            <small class="text-muted">Returns: HTML preview</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <strong>GET</strong> /api/health
                        </div>
                        <div class="card-body">
                            <p class="card-text">Health check endpoint</p>
                            <small class="text-muted">Returns: Service status</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 מחולל חשבוניות PDF. נבנה לאוטומציה וזרימות n8n.</p>
            <div class="mt-2">
                <a href="/docs" class="text-white-50 me-3">תיעוד</a>
                <a href="/api/health" class="text-white-50 me-3">בדיקת תקינות</a>
                <a href="https://github.com" class="text-white-50">GitHub</a>
            </div>
            <div class="mt-2 text-white-50">דף זה נבנה ע''י BrainboxAI</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
    <script>
      const apiBaseEl = document.getElementById('apiBase');
      const apiKeyEl = document.getElementById('apiKey');
      const base = () => (localStorage.getItem('apiBase') || apiBaseEl.value || '').replace(/\/$/, '');
      const key = () => (localStorage.getItem('apiKey') || apiKeyEl.value || '');
      const themeToggleEl = document.getElementById('themeToggle');

      function applyTheme(theme){
        document.documentElement.setAttribute('data-bs-theme', theme);
        localStorage.setItem('theme', theme);
        if(themeToggleEl) themeToggleEl.checked = theme === 'dark';
      }

      function initTheme(){
        const saved = localStorage.getItem('theme');
        const preferred = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        applyTheme(saved || preferred);
        if(themeToggleEl){
          themeToggleEl.addEventListener('change', () => applyTheme(themeToggleEl.checked ? 'dark' : 'light'));
        }
      }

      async function loadStats(){
        try {
          const h = await fetch('/api/health').then(r=>r.json());
          document.getElementById('statHealth').textContent = h.success ? 'תקין' : 'שגיאה';
          document.getElementById('statHealthTime').textContent = h.timestamp || '';
        } catch {}
        try {
          const t = await fetch('/api/templates').then(r=>r.json());
          if(t.success){
            document.getElementById('statTemplates').textContent = t.templates.length;
            const list = document.getElementById('templateList');
            list.innerHTML = t.templates.map(name => `
              <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="/templates/edit/${name}">
                <span><i class="bi bi-file-earmark-text me-2"></i>${name}</span>
                <span class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-secondary" onclick="event.preventDefault(); window.location='/templates/edit/${name}'">עריכה</button>
                  <button class="btn btn-sm btn-primary" onclick="event.preventDefault(); previewName('${name}')">תצוגה</button>
                </span>
              </a>`).join('');
          }
        } catch {}
        document.getElementById('statApiBase').textContent = localStorage.getItem('apiBase') || '—';
      }

      function savePrefs(){
        localStorage.setItem('apiBase', apiBaseEl.value.trim());
        localStorage.setItem('apiKey', apiKeyEl.value.trim());
        document.getElementById('statApiBase').textContent = apiBaseEl.value.trim();
      }

      function payloadFromQuick(templateType){
        return {
          templateType,
          customer: { name: document.getElementById('qName').value, email: 'test@example.com' },
          items: [{ description: document.getElementById('qDesc').value, quantity: 1, rate: Number(document.getElementById('qTotal').value), amount: Number(document.getElementById('qTotal').value) }],
          total: Number(document.getElementById('qTotal').value)
        };
      }

      async function submitTemplatePdf(){
        const tpl = document.getElementById('qTemplate').value;
        const res = await fetch(`${base() || ''}/api/generate-pdf`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(key() && {'x-api-key': key()}) }, body: JSON.stringify(payloadFromQuick(tpl)) });
        if(!res.ok){ alert('קריאת API נכשלה'); return; }
        const blob = await res.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${tpl}-${Date.now()}.pdf`; a.click(); URL.revokeObjectURL(url);
      }

      async function openPreview(){
        const tpl = document.getElementById('qTemplate').value;
        const res = await fetch('/api/preview', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payloadFromQuick(tpl)) });
        const html = await res.text(); const w = window.open('', '_blank'); w.document.write(html); w.document.close();
      }

      async function previewName(name){
        const res = await fetch('/api/preview', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ templateType: name, customer:{ name: 'ישראל' }, items:[{ description:'שירות', quantity:1, rate:100, amount:100 }], total:100 }) });
        const html = await res.text(); const w = window.open('', '_blank'); w.document.write(html); w.document.close();
      }

      function loadHtmlSample(){
        const sample = `<!DOCTYPE html>\n<html lang=\"he\" dir=\"rtl\"><head><meta charset=\"UTF-8\"><title>מסמך</title></head><body style=\"font-family:Heebo, Arial; direction:rtl; text-align:right; padding:24px;\"><h1>שלום עולם</h1><p>זהו מסמך בדיקה להמרה ל‑PDF.</p></body></html>`;
        document.getElementById('qHtml').value = sample;
      }

      async function submitHtmlPdf(){
        const html = document.getElementById('qHtml').value.trim();
        if(!html){ alert('נא להדביק HTML'); return; }
        const res = await fetch(`${base() || ''}/api/html-to-pdf`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(key() && {'x-api-key': key()}) }, body: JSON.stringify({ html, filename: `html-${Date.now()}` }) });
        if(!res.ok){ alert('קריאת API נכשלה'); return; }
        const blob = await res.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `html-${Date.now()}.pdf`; a.click(); URL.revokeObjectURL(url);
      }

      async function quickSamplePdf(){
        document.getElementById('qTemplate').value = 'receipt';
        document.getElementById('qName').value = 'ישראל ישראלי';
        document.getElementById('qTotal').value = '100';
        document.getElementById('qDesc').value = 'שירות לדוגמה';
        await submitTemplatePdf();
      }

      // init
      (function(){
        apiBaseEl.value = localStorage.getItem('apiBase') || '';
        apiKeyEl.value = localStorage.getItem('apiKey') || '';
        initTheme();
        loadStats();
        loadHtmlSample();
      })();
    </script>
</body>
</html>