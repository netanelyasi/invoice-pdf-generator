<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
  body { background: var(--bs-body-bg); color: var(--bs-body-color); }
  .sidebar { height: calc(100vh - 56px); position: sticky; top: 56px; overflow-y: auto; }
  .block { background: var(--bs-body-bg); border: 1px dashed var(--bs-border-color); border-radius: .5rem; padding: .75rem; margin-bottom: .75rem; cursor: grab; }
  .canvas { min-height: 60vh; background: var(--bs-body-bg); border: 2px dashed var(--bs-border-color); border-radius: .5rem; padding: 1rem; }
  .canvas .block { border-style: solid; cursor: grab; }
  .drag-over { background: var(--bs-tertiary-bg); }
  .toolbar { position: sticky; top: 56px; z-index: 1020; background: var(--bs-body-bg); border-bottom: 1px solid var(--bs-border-color); box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
  .toolbar .container, .toolbar .container-fluid { overflow-x: auto; }
  .toolbar .input-group { direction: rtl; }
  .code-preview { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre; background: var(--bs-tertiary-bg); color: var(--bs-body-color); border-radius: .5rem; border: 1px solid var(--bs-border-color); }
  [data-bs-theme="dark"] .code-preview { background: #0f1012; color: #e5e7eb; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="/">ğŸ“„ ××—×•×œ×œ ×—×©×‘×•× ×™×•×ª</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/templates">×ª×‘× ×™×•×ª</a>
        <div class="nav-item ms-3 form-check form-switch">
          <input class="form-check-input" type="checkbox" id="themeToggle">
          <label class="form-check-label" for="themeToggle">×›×”×”</label>
        </div>
      </div>
    </div>
  </nav>

  <div class="toolbar py-2 mt-5">
    <div class="container d-flex align-items-center gap-2 flex-wrap">
      <div class="input-group flex-nowrap" style="max-width: 360px;">
        <span class="input-group-text">×©× ×ª×‘× ×™×ª</span>
        <input id="templateName" class="form-control" placeholder="receipt / tax_invoice / ..." value="<%= name %>" />
      </div>
      <div class="input-group flex-nowrap" style="max-width: 360px;">
        <span class="input-group-text">API Base</span>
        <input id="apiBase" class="form-control" placeholder="http://localhost:3000" />
      </div>
      <div class="input-group flex-nowrap" style="max-width: 320px;">
        <span class="input-group-text">API Key</span>
        <input id="apiKey" class="form-control" placeholder="x-api-key" />
      </div>
      <button class="btn btn-outline-secondary" onclick="handleLoad()"><i class="bi bi-download me-1"></i>×˜×¢×Ÿ ×§×™×™××ª</button>
      <button class="btn btn-secondary" onclick="handlePreview()"><i class="bi bi-eye me-1"></i>×ª×¦×•×’×ª ×ª×‘× ×™×ª</button>
      <button class="btn btn-primary" onclick="handleSave()"><i class="bi bi-save me-1"></i>×©××™×¨×” ×œ×ª×‘× ×™×ª</button>
      <div class="btn-group" role="group">
        <button class="btn btn-outline-dark" onclick="handleExport()"><i class="bi bi-code me-1"></i>×™×™×¦×•× HTML</button>
        <button class="btn btn-outline-primary" onclick="handleGeneratePDF()"><i class="bi bi-file-earmark-pdf me-1"></i>PDF ××ª×‘× ×™×ª</button>
      </div>
      <div class="form-check form-switch ms-auto">
        <input class="form-check-input" type="checkbox" id="htmlModeToggle" onchange="toggleHtmlMode(this.checked)">
        <label class="form-check-label" for="htmlModeToggle">××¦×‘ HTML ×™×©×™×¨</label>
      </div>
    </div>
  </div>

  <div class="container-fluid mt-3">
    <div class="row">
      <aside class="col-md-3">
        <div class="sidebar p-3 rounded shadow-sm bg-body border">
          <h5 class="mb-3">×‘×œ×•×§×™× ×œ×’×¨×™×¨×”</h5>
          <div class="block" draggable="true" data-block="header">×›×•×ª×¨×ª + ×¤×¨×˜×™ ×¢×¡×§</div>
          <div class="block" draggable="true" data-block="taxBadge">×ª×’×™×ª ×—×©×‘×•× ×™×ª ××¡</div>
          <div class="block" draggable="true" data-block="customer">×¤×¨×˜×™ ×œ×§×•×—</div>
          <div class="block" draggable="true" data-block="items">×˜×‘×œ×ª ×¤×¨×™×˜×™×</div>
          <div class="block" draggable="true" data-block="taxInfo">××™×“×¢ ××¡ (××•×¤×¦×™×•× ×œ×™)</div>
          <div class="block" draggable="true" data-block="totals">×¡×™×›×•××™×</div>
          <div class="block" draggable="true" data-block="notes">×”×¢×¨×•×ª</div>
          <div class="block" draggable="true" data-block="thanks">×‘×¨×›×ª ×ª×•×“×”</div>
          <div class="block" draggable="true" data-block="credit">×§×¨×“×™×˜ BrainboxAI</div>
          <hr />
          <div class="block" draggable="true" data-block="exempt">×”×•×“×¢×ª ×¢×¡×§×” ×¤×˜×•×¨×”</div>
          <hr/>
          <div class="block" draggable="true" data-block="cover">×¢××•×“ ×©×¢×¨</div>
          <div class="block" draggable="true" data-block="heading">×›×•×ª×¨×ª</div>
          <div class="block" draggable="true" data-block="paragraph">×¤×¡×§×”</div>
          <div class="block" draggable="true" data-block="image">×ª××•× ×”</div>
          <div class="block" draggable="true" data-block="columns">×©×ª×™ ×¢××•×“×•×ª</div>
          <div class="block" draggable="true" data-block="tableSimple">×˜×‘×œ×” ×›×œ×œ×™×ª</div>
          <div class="block" draggable="true" data-block="list">×¨×©×™××”</div>
          <div class="block" draggable="true" data-block="signature">×—×ª×™××•×ª</div>
          <div class="block" draggable="true" data-block="pageBreak">××¢×‘×¨ ×¢××•×“</div>
        </div>
      </aside>
      <main class="col-md-6">
        <div id="canvas" class="canvas shadow-sm border" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
          <div class="text-center text-muted py-5">×’×¨×¨×• ×‘×œ×•×§×™× ×œ×›××Ÿ ×›×“×™ ×œ×‘× ×•×ª ××ª ×”×ª×‘× ×™×ª</div>
        </div>
      </main>
      <aside class="col-md-3">
        <div class="p-3 rounded shadow-sm bg-body border">
          <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pills-code-tab" data-bs-toggle="pill" data-bs-target="#pills-code" type="button" role="tab">HTML</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="pills-data-tab" data-bs-toggle="pill" data-bs-target="#pills-data" type="button" role="tab">× ×ª×•× ×™ ×“×•×’××”</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="pills-theme-tab" data-bs-toggle="pill" data-bs-target="#pills-theme" type="button" role="tab">×¢×¨×›×ª × ×•×©×</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="pills-htmlmode-tab" data-bs-toggle="pill" data-bs-target="#pills-htmlmode" type="button" role="tab">HTML ×™×©×™×¨</button>
            </li>
          </ul>
          <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-code" role="tabpanel">
              <h6 class="mb-2">×§×•×“ ×ª×•×¦××” (×§×¨×™××” ×‘×œ×‘×“)</h6>
              <pre id="code" class="code-preview p-3 small"></pre>
            </div>
            <div class="tab-pane fade" id="pills-data" role="tabpanel">
              <div class="mb-2 d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="loadSampleData()">×˜×¢×Ÿ ×“×•×’××”</button>
                <button class="btn btn-outline-success btn-sm" onclick="savePrefs()">×©××•×¨</button>
              </div>
              <textarea id="dataJson" class="form-control" rows="12" placeholder='{"customer":{"name":"×™×©×¨××œ"},"items":[{"description":"×©×™×¨×•×ª","quantity":1,"rate":100,"amount":100}],"total":100}'></textarea>
            </div>
            <div class="tab-pane fade" id="pills-theme" role="tabpanel">
              <div class="mb-3">
                <label class="form-label">×¤×•× ×˜</label>
                <select id="fontSelect" class="form-select">
                  <option value="Heebo">Heebo</option>
                  <option value="Noto Sans Hebrew">Noto Sans Hebrew</option>
                  <option value="Assistant">Assistant</option>
                  <option value="Rubik">Rubik</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Primary color</label>
                <input id="primaryColor" type="color" class="form-control form-control-color" value="#2c3e50" />
              </div>
              <div class="text-muted small">×”×‘×—×™×¨×•×ª ×™×•×˜××¢×• ×‘Ö¾HTML ×‘×–××Ÿ ×™×¦×™×¨×”.</div>
            </div>
            <div class="tab-pane fade" id="pills-htmlmode" role="tabpanel">
              <div class="mb-2 d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="previewRawHtml()">×ª×¦×•×’×”</button>
                <button class="btn btn-outline-primary btn-sm" onclick="generatePdfFromHtml()">PDF ×Ö¾HTML</button>
              </div>
              <textarea id="rawHtml" class="form-control" rows="12" placeholder="×”×“×‘×§ ×›××Ÿ HTML ××œ×"></textarea>
              <div class="form-text">×œ×©×™××•×© ×¢× /api/html-to-pdf (× ×“×¨×© API Key).</div>
            </div>
          </div>
          <div class="mt-3 text-muted small">×˜×™×¤: ×©××¨×• API Base ×•Ö¾Key ×‘×œ×—×™×¦×” ×¢×œ "×©××•×¨". ×”×©××™×¨×” ×”×™× ×‘×œ×•×§××œ×™×ª ×‘×“×¤×“×¤×Ÿ.</div>
        </div>
      </aside>
    </div>
  </div>

  <footer class="text-center text-muted py-3">×“×£ ×–×” × ×‘× ×” ×¢''×™ BrainboxAI</footer>

  <script>
    // Theme toggle (Bootstrap 5.3 CSS variables)
    (function(){
      const toggle = document.getElementById('themeToggle');
      const applyTheme = (t) => { document.documentElement.setAttribute('data-bs-theme', t); localStorage.setItem('theme', t); if(toggle) toggle.checked = t==='dark'; };
      const saved = localStorage.getItem('theme');
      const preferred = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      applyTheme(saved || preferred);
      if(toggle) toggle.addEventListener('change', ()=> applyTheme(toggle.checked ? 'dark' : 'light'));
    })();
    const blockLibrary = {
      header: `
        <div class="header" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:40px;border-bottom:2px solid var(--bs-border-color, #e0e0e0);padding-bottom:20px;">
          <div>
            {{#if business.logo}}<img src="{{business.logo}}" alt="{{business.name}}" style="max-width:150px;max-height:80px;margin-bottom:10px;" />{{/if}}
            <div style="font-size:24px;font-weight:700;color:var(--bs-primary, #2c3e50);margin-bottom:5px;">{{business.name}}</div>
            <div style="color:var(--bs-secondary-color, #666);line-height:1.6;">
              {{business.address}}<br/>
              {{business.city}}, {{business.state}} {{business.postalCode}}<br/>
              {{#if business.phone}}×˜×œ×¤×•×Ÿ: {{business.phone}}<br/>{{/if}}
              {{#if business.email}}××™××™×™×œ: {{business.email}}<br/>{{/if}}
              {{#if business.website}}××ª×¨: {{business.website}}<br/>{{/if}}
              {{#if business.abn}}×¢.×/×¢×•×¡×§: {{business.abn}}{{/if}}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:36px;font-weight:700;color:var(--bs-primary, #2c3e50);margin-bottom:10px;">××¡××š</div>
            <div style="background:var(--bs-tertiary-bg, #f8f9fa);padding:15px;border-radius:5px;border-left:4px solid var(--bs-primary, #3498db);">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="font-weight:700;color:var(--bs-primary, #2c3e50);">××¡×³:</span>
                <span>{{invoiceNumber}}</span>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="font-weight:700;color:var(--bs-primary, #2c3e50);">×ª××¨×™×š:</span>
                <span>{{formatDate invoiceDate 'DD/MM/YYYY'}}</span>
              </div>
            </div>
          </div>
        </div>
      `,
      taxBadge: `
        <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
          <div style="background:var(--bs-danger, #e74c3c);color:#fff;padding:8px 12px;border-radius:6px;font-weight:700;">×—×©×‘×•× ×™×ª ××¡</div>
        </div>
      `,
      customer: `
        <div style="margin-bottom:30px;">
          <div style="font-size:16px;font-weight:700;color:var(--bs-primary, #2c3e50);margin-bottom:10px;text-transform:uppercase;">×œ×›×‘×•×“</div>
          <div style="background:var(--bs-tertiary-bg, #f8f9fa);padding:15px;border-radius:5px;border-left:4px solid var(--bs-success, #27ae60);">
            <strong>{{customer.name}}</strong><br/>
            {{#if customer.address}}{{customer.address}}<br/>{{customer.city}}, {{customer.state}} {{customer.postalCode}}<br/>{{/if}}
            {{#if customer.email}}××™××™×™×œ: {{customer.email}}<br/>{{/if}}
            {{#if customer.phone}}×˜×œ×¤×•×Ÿ: {{customer.phone}}{{/if}}
          </div>
        </div>
      `,
      items: `
        <table style="width:100%;border-collapse:collapse;margin-bottom:30px;background:var(--bs-body-bg, #fff);box-shadow:0 2px 4px rgba(0,0,0,.08);border-radius:5px;overflow:hidden;border:1px solid var(--bs-border-color,#ecf0f1);">
          <thead>
            <tr>
              <th style="background:var(--bs-primary, #3498db);color:#fff;padding:15px 10px;text-align:right;">×ª×™××•×¨</th>
              <th style="background:var(--bs-primary, #3498db);color:#fff;padding:15px 10px;text-align:center;">×›××•×ª</th>
              <th style="background:var(--bs-primary, #3498db);color:#fff;padding:15px 10px;text-align:left;">××—×™×¨ ×™×—×³</th>
              <th style="background:var(--bs-primary, #3498db);color:#fff;padding:15px 10px;text-align:left;">×¡×›×•×</th>
            </tr>
          </thead>
          <tbody>
            {{#each items}}
            <tr>
              <td style="padding:12px 10px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);">{{description}}</td>
              <td style="padding:12px 10px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);text-align:center;">{{quantity}}</td>
              <td style="padding:12px 10px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);text-align:left;">{{formatCurrency rate ../currency}}</td>
              <td style="padding:12px 10px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);text-align:left;">{{formatCurrency amount ../currency}}</td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      `,
      taxInfo: `
        {{#if taxRate}}
        <div style="background:var(--bs-warning-bg-subtle,#fff3cd);border:2px solid var(--bs-warning,#ffc107);border-radius:6px;padding:15px;margin-bottom:20px;">
          <div style="font-weight:700;color:var(--bs-warning-text-emphasis,#856404);margin-bottom:8px;">××™×“×¢ ××¡</div>
          <div>
            ×©×™×¢×•×¨ ××¡: {{taxRate}}% | ×¡×›×•× ××¡: <strong>{{formatCurrency taxAmount currency}}</strong>
          </div>
        </div>
        {{/if}}
      `,
      totals: `
        <div style="display:flex;justify-content:flex-end;margin-bottom:30px;">
          <table style="min-width:300px;border-collapse:collapse;">
            <tr>
              <td style="padding:8px 15px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);text-align:right;font-weight:700;color:var(--bs-primary,#2c3e50);">×¡×™×›×•× ×‘×™× ×™×™×:</td>
              <td style="padding:8px 15px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);text-align:left;font-weight:700;">{{formatCurrency subtotal currency}}</td>
            </tr>
            {{#if taxRate}}
            <tr>
              <td style="padding:8px 15px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);text-align:right;font-weight:700;color:var(--bs-primary,#2c3e50);">××¡ ({{taxRate}}%):</td>
              <td style="padding:8px 15px;border-bottom:1px solid var(--bs-border-color,#ecf0f1);text-align:left;font-weight:700;">{{formatCurrency taxAmount currency}}</td>
            </tr>
            {{/if}}
            <tr>
              <td style="padding:8px 15px;background:var(--bs-primary,#2c3e50);color:#fff;text-align:right;font-weight:700;">×¡×”"×›:</td>
              <td style="padding:8px 15px;background:var(--bs-primary,#2c3e50);color:#fff;text-align:left;font-weight:700;">{{formatCurrency total currency}}</td>
            </tr>
          </table>
        </div>
      `,
      notes: `
        {{#if notes}}
        <div style="margin-top:10px;">
          <div style="font-size:16px;font-weight:700;color:var(--bs-primary,#2c3e50);margin-bottom:10px;">×”×¢×¨×•×ª</div>
          <div style="background:var(--bs-warning-bg-subtle,#fff3cd);border:1px solid var(--bs-warning,#ffeaa7);border-radius:5px;padding:15px;color:var(--bs-warning-text-emphasis,#856404);">{{notes}}</div>
        </div>
        {{/if}}
      `,
      thanks: `
        <div style="text-align:center;margin-top:30px;font-size:16px;color:var(--bs-success,#27ae60);font-weight:700;">×ª×•×“×” ×¢×œ ×”×¢×¡×§×”!</div>
      `,
      credit: `
        <div style="text-align:center;margin-top:14px;font-size:10px;color:var(--bs-secondary-color,#666);">×“×£ ×–×” × ×‘× ×” ×¢''×™ BrainboxAI</div>
      `,
      exempt: `
        <div style="background:color-mix(in srgb, var(--bs-success,#27ae60) 10%, transparent);border:2px solid var(--bs-success,#27ae60);border-radius:6px;padding:15px;margin-bottom:20px;text-align:center;">
          <div style="font-weight:700;color:var(--bs-success,#27ae60);margin-bottom:8px;">×¢×¡×§×” ×¤×˜×•×¨×” ×××¡</div>
          <div style="color:color-mix(in srgb, var(--bs-success,#27ae60) 40%, var(--bs-body-color,#333));">×§×‘×œ×” ×–×• ××ª×™×™×—×¡×ª ×œ×¢×¡×§×” ×”×¤×˜×•×¨×” ×××¡. ×œ× × ×’×‘×” ××¡ ×‘×”×ª×× ×œ×ª×§× ×•×ª ×”××¡ ×”×—×œ×•×ª.</div>
        </div>
      `
    };

    const scaffold = (inner) => {
      const font = localStorage.getItem('font') || 'Heebo';
      const primary = localStorage.getItem('primary') || '#2c3e50';
      const gfont = encodeURIComponent(font);
      return `<!DOCTYPE html>
<html lang=\"he\" dir=\"rtl\">\n<head>\n<meta charset=\"UTF-8\"/>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n<title>{{invoiceNumber}}</title>\n<link href=\"https://fonts.googleapis.com/css2?family=${gfont}:wght@300;400;600;700;900&display=swap\" rel=\"stylesheet\">\n<style>body{font-family:'${font}','Noto Sans Hebrew','Arial Unicode MS','Segoe UI',Arial,sans-serif;font-size:12px;line-height:1.4;color:#333;background:#fff} a{color:${primary}} .container{max-width:800px;margin:0 auto;padding:40px 30px}</style>\n</head>\n<body>\n<div class=\"container\">\n${inner}\n<div style=\"text-align:center;margin-top:20px;font-size:10px;color:#666;\">× ×•×¦×¨ ×‘×ª××¨×™×š {{formatDate generatedDate 'DD/MM/YYYY HH:mm:ss'}}</div>\n</div>\n</body>\n</html>`;
    };

    const canvasEl = document.getElementById('canvas');
    const codeEl = document.getElementById('code');

    function handleDragOver(e){ e.preventDefault(); canvasEl.classList.add('drag-over'); }
    function handleDrop(e){
      e.preventDefault(); canvasEl.classList.remove('drag-over');
      const type = e.dataTransfer.getData('text/plain');
      appendBlock(type);
      renderCode();
    }

    document.querySelectorAll('[draggable=true][data-block]').forEach(el => {
      el.addEventListener('dragstart', (ev) => {
        ev.dataTransfer.setData('text/plain', el.dataset.block);
      });
    });

    function appendBlock(type){
      if(!blockLibrary[type]) return;
      const wrapper = document.createElement('div');
      wrapper.className = 'block';
      wrapper.draggable = true;
      wrapper.innerHTML = `<div class="d-flex justify-content-between align-items-center mb-2"><strong>${labelOf(type)}</strong><div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary" onclick="moveUp(this)"><i class='bi bi-arrow-up'></i></button><button class="btn btn-outline-secondary" onclick="moveDown(this)"><i class='bi bi-arrow-down'></i></button><button class="btn btn-outline-danger" onclick="removeBlock(this)"><i class='bi bi-trash'></i></button></div></div><div class="block-body">${blockLibrary[type]}</div>`;
      canvasEl.appendChild(wrapper);
    }

    function labelOf(type){
      const map = { header:'×›×•×ª×¨×ª + ×¤×¨×˜×™ ×¢×¡×§', taxBadge:'×ª×’×™×ª ×—×©×‘×•× ×™×ª ××¡', customer:'×¤×¨×˜×™ ×œ×§×•×—', items:'×˜×‘×œ×ª ×¤×¨×™×˜×™×', taxInfo:'××™×“×¢ ××¡', totals:'×¡×™×›×•××™×', notes:'×”×¢×¨×•×ª', thanks:'×‘×¨×›×ª ×ª×•×“×”', credit:'×§×¨×“×™×˜', exempt:'×”×•×“×¢×ª ×¤×˜×•×¨', cover:'×¢××•×“ ×©×¢×¨', heading:'×›×•×ª×¨×ª', paragraph:'×¤×¡×§×”', image:'×ª××•× ×”', columns:'×©×ª×™ ×¢××•×“×•×ª', tableSimple:'×˜×‘×œ×” ×›×œ×œ×™×ª', list:'×¨×©×™××”', signature:'×—×ª×™××•×ª', pageBreak:'××¢×‘×¨ ×¢××•×“' };
      return map[type] || type;
    }

    function removeBlock(btn){ btn.closest('.block').remove(); renderCode(); }
    function moveUp(btn){ const el = btn.closest('.block'); const prev = el.previousElementSibling; if(prev) { el.parentNode.insertBefore(el, prev); renderCode(); } }
    function moveDown(btn){ const el = btn.closest('.block'); const next = el.nextElementSibling; if(next) { el.parentNode.insertBefore(next, el); renderCode(); } }

    function collectHtml(){
      const bodies = Array.from(canvasEl.querySelectorAll('.block-body')).map(x => x.innerHTML.trim());
      return scaffold(bodies.join('\n'));
    }

    function renderCode(){ codeEl.textContent = collectHtml(); }

    async function handleSave(){
      const name = document.getElementById('templateName').value.trim();
      if(!name){ alert('× × ×œ×”×–×™×Ÿ ×©× ×ª×‘× ×™×ª'); return; }
      const content = collectHtml();
      const res = await fetch(`/api/templates/${encodeURIComponent(name)}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content }) });
      const data = await res.json();
      if(!data.success){ alert(data.error || '×©××™×¨×” × ×›×©×œ×”'); return; }
      alert('×”×ª×‘× ×™×ª × ×©××¨×” ×‘×”×¦×œ×—×”');
    }

    async function handlePreview(){
      const name = document.getElementById('templateName').value.trim() || 'receipt';
      // ×ª×¦×•×’×” ××§×“×™××” ××©×ª××©×ª ×‘-API ×•××¦×™×’×” ×‘×—×œ×•×Ÿ
      const payload = getDataPayload(name);
      const r = await fetch('/api/preview', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const html = await r.text();
      const w = window.open('', '_blank'); w.document.write(html); w.document.close();
    }

    async function handleLoad(){
      const name = document.getElementById('templateName').value.trim();
      if(!name){ alert('× × ×œ×”×–×™×Ÿ ×©× ×ª×‘× ×™×ª'); return; }
      const res = await fetch(`/api/templates/${encodeURIComponent(name)}`);
      const data = await res.json();
      if(!data.success){ alert(data.error || '×˜×¢×™× ×” × ×›×©×œ×”'); return; }
      // × ×˜×¢×Ÿ ×›×‘×œ×•×§ ××—×“ ×©×œ HTML ×’×•×œ××™
      canvasEl.innerHTML = '';
      const raw = document.createElement('div');
      raw.className = 'block';
      raw.innerHTML = `<div class="d-flex justify-content-between align-items-center mb-2"><strong>HTML ×§×™×™×</strong><div class="btn-group btn-group-sm"><button class="btn btn-outline-danger" onclick="removeBlock(this)"><i class='bi bi-trash'></i></button></div></div><div class='block-body'>${escapeHtml(data.content)}</div>`;
      canvasEl.appendChild(raw);
      renderCode();
    }

    function handleExport(){
      const content = collectHtml();
      const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'template.html'; a.click();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str){
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // ---- Enhancements: data editor, prefs, and direct API actions ----
    function getDataPayload(templateType){
      let data = {};
      try { data = JSON.parse(document.getElementById('dataJson').value || '{}'); } catch {}
      return { templateType, ...data };
    }

    function loadSampleData(){
      const sample = {
        customer:{ name:'×™×©×¨××œ ×™×©×¨××œ×™', email:'israel@example.com', phone:'+972-55-1234567' },
        items:[{ description:'×©×™×¨×•×ª', quantity:1, rate:100, amount:100 }],
        subtotal:100, total:100, currency:'â‚ª'
      };
      document.getElementById('dataJson').value = JSON.stringify(sample, null, 2);
    }

    function savePrefs(){
      localStorage.setItem('apiBase', document.getElementById('apiBase').value.trim());
      localStorage.setItem('apiKey', document.getElementById('apiKey').value.trim());
      const fontSel = document.getElementById('fontSelect');
      const colorEl = document.getElementById('primaryColor');
      if (fontSel) localStorage.setItem('font', fontSel.value);
      if (colorEl) localStorage.setItem('primary', colorEl.value);
      alert('×”×’×“×¨×•×ª × ×©××¨×•');
    }

    function toggleHtmlMode(on){
      const tabTrigger = document.querySelector('#pills-htmlmode-tab');
      if(on && tabTrigger) new bootstrap.Tab(tabTrigger).show();
    }

    async function handleGeneratePDF(){
      const apiBase = localStorage.getItem('apiBase') || document.getElementById('apiBase').value.trim() || '';
      const apiKey = localStorage.getItem('apiKey') || document.getElementById('apiKey').value.trim() || '';
      if(!apiBase){ alert('× × ×œ×”×’×“×™×¨ API Base'); return; }
      const name = document.getElementById('templateName').value.trim() || 'receipt';
      const payload = getDataPayload(name);
      const res = await fetch(`${apiBase.replace(/\/$/,'')}/api/generate-pdf`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(apiKey && { 'x-api-key': apiKey }) }, body: JSON.stringify(payload) });
      if(!res.ok){ alert('×§×¨×™××ª API × ×›×©×œ×”'); return; }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${name}-${Date.now()}.pdf`; a.click(); URL.revokeObjectURL(url);
    }

    function previewRawHtml(){
      const html = document.getElementById('rawHtml').value.trim();
      if(!html){ alert('× × ×œ×”×“×‘×™×§ HTML'); return; }
      const w = window.open('', '_blank'); w.document.write(html); w.document.close();
    }

    async function generatePdfFromHtml(){
      const apiBase = localStorage.getItem('apiBase') || document.getElementById('apiBase').value.trim() || '';
      const apiKey = localStorage.getItem('apiKey') || document.getElementById('apiKey').value.trim() || '';
      const html = document.getElementById('rawHtml').value.trim();
      if(!apiBase || !html){ alert('× × ×œ×”×’×“×™×¨ API Base ×•×œ×”×“×‘×™×§ HTML'); return; }
      const res = await fetch(`${apiBase.replace(/\/$/,'')}/api/html-to-pdf`, { method:'POST', headers:{ 'Content-Type':'application/json', ...(apiKey && { 'x-api-key': apiKey }) }, body: JSON.stringify({ html, filename: `raw-${Date.now()}` }) });
      if(!res.ok){ alert('×§×¨×™××ª API × ×›×©×œ×”'); return; }
      const blob = await res.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `raw-${Date.now()}.pdf`; a.click(); URL.revokeObjectURL(url);
    }

    // init from localStorage
    (function(){
      const apiBase = localStorage.getItem('apiBase') || '';
      const apiKey = localStorage.getItem('apiKey') || '';
      const font = localStorage.getItem('font') || 'Heebo';
      const primary = localStorage.getItem('primary') || '#2c3e50';
      document.getElementById('apiBase').value = apiBase;
      document.getElementById('apiKey').value = apiKey;
      const fontSel = document.getElementById('fontSelect'); if(fontSel) fontSel.value = font;
      const prim = document.getElementById('primaryColor'); if(prim) prim.value = primary;
      // Load default sample data
      const dataArea = document.getElementById('dataJson');
      if (dataArea && !dataArea.value) {
        loadSampleData();
      }
    })();
  </script>
</body>
</html>


