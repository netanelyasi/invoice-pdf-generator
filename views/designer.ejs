<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { background: #f6f7fb; }
    .sidebar { height: calc(100vh - 56px); position: sticky; top: 56px; overflow-y: auto; }
    .block { background: #fff; border: 1px dashed #ced4da; border-radius: .5rem; padding: .75rem; margin-bottom: .75rem; cursor: grab; }
    .canvas { min-height: 60vh; background: #fff; border: 2px dashed #adb5bd; border-radius: .5rem; padding: 1rem; }
    .canvas .block { border-style: solid; cursor: grab; }
    .drag-over { background: #f1f3f5; }
    .toolbar { position: sticky; top: 56px; z-index: 1020; background: #fff; border-bottom: 1px solid #e9ecef; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    .toolbar .container, .toolbar .container-fluid { overflow-x: auto; }
    .toolbar .input-group { direction: rtl; }
    .code-preview { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre; background: #1e1e1e; color: #e5e5e5; border-radius: .5rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="/">  砖转</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/templates">转转</a>
      </div>
    </div>
  </nav>

  <div class="toolbar py-2 mt-5">
    <div class="container d-flex align-items-center gap-2 flex-wrap">
      <div class="input-group flex-nowrap" style="max-width: 520px;">
        <span class="input-group-text">砖 转转</span>
        <input id="templateName" class="form-control" placeholder="receipt / tax_invoice / ..." value="<%= name %>" />
      </div>
      <button class="btn btn-outline-secondary" onclick="handleLoad()"><i class="bi bi-download me-1"></i>注 拽转</button>
      <button class="btn btn-secondary" onclick="handlePreview()"><i class="bi bi-eye me-1"></i>转爪 拽</button>
      <button class="btn btn-primary" onclick="handleSave()"><i class="bi bi-save me-1"></i>砖专 转转</button>
      <button class="btn btn-outline-dark" onclick="handleExport()"><i class="bi bi-code me-1"></i>爪 HTML</button>
    </div>
  </div>

  <div class="container-fluid mt-3">
    <div class="row">
      <aside class="col-md-3">
        <div class="sidebar p-3 bg-white rounded shadow-sm">
          <h5 class="mb-3">拽 专专</h5>
          <div class="block" draggable="true" data-block="header">转专转 + 驻专 注住拽</div>
          <div class="block" draggable="true" data-block="taxBadge">转转 砖转 住</div>
          <div class="block" draggable="true" data-block="customer">驻专 拽</div>
          <div class="block" draggable="true" data-block="items">转 驻专</div>
          <div class="block" draggable="true" data-block="taxInfo">注 住 (驻爪)</div>
          <div class="block" draggable="true" data-block="totals">住</div>
          <div class="block" draggable="true" data-block="notes">注专转</div>
          <div class="block" draggable="true" data-block="thanks">专转 转</div>
          <div class="block" draggable="true" data-block="credit">拽专 BrainboxAI</div>
          <hr />
          <div class="block" draggable="true" data-block="exempt">注转 注住拽 驻专</div>
        </div>
      </aside>
      <main class="col-md-6">
        <div id="canvas" class="canvas shadow-sm" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
          <div class="text-center text-muted py-5">专专 拽   转 转 转转</div>
        </div>
      </main>
      <aside class="col-md-3">
        <div class="p-3 bg-white rounded shadow-sm">
          <h5 class="mb-3">拽 转爪 (转爪 )</h5>
          <pre id="code" class="code-preview p-3 small"></pre>
          <div class="mt-3 text-muted small">驻: 砖转砖 拽 .  砖专  爪专 转转 Handlebars  (HTML + CSS) 注专转 志RTL.</div>
        </div>
      </aside>
    </div>
  </div>

  <footer class="text-center text-muted py-3">祝   注'' BrainboxAI</footer>

  <script>
    const blockLibrary = {
      header: `
        <div class="header" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:40px;border-bottom:2px solid #e0e0e0;padding-bottom:20px;">
          <div>
            {{#if business.logo}}<img src="{{business.logo}}" alt="{{business.name}}" style="max-width:150px;max-height:80px;margin-bottom:10px;" />{{/if}}
            <div style="font-size:24px;font-weight:700;color:#2c3e50;margin-bottom:5px;">{{business.name}}</div>
            <div style="color:#666;line-height:1.6;">
              {{business.address}}<br/>
              {{business.city}}, {{business.state}} {{business.postalCode}}<br/>
              {{#if business.phone}}驻: {{business.phone}}<br/>{{/if}}
              {{#if business.email}}: {{business.email}}<br/>{{/if}}
              {{#if business.website}}转专: {{business.website}}<br/>{{/if}}
              {{#if business.abn}}注./注住拽: {{business.abn}}{{/if}}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:36px;font-weight:700;color:#2c3e50;margin-bottom:10px;">住</div>
            <div style="background:#f8f9fa;padding:15px;border-radius:5px;border-left:4px solid #3498db;">
              <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="font-weight:700;color:#2c3e50;">住壮:</span>
                <span>{{invoiceNumber}}</span>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="font-weight:700;color:#2c3e50;">转专:</span>
                <span>{{formatDate invoiceDate 'DD/MM/YYYY'}}</span>
              </div>
            </div>
          </div>
        </div>
      `,
      taxBadge: `
        <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
          <div style="background:#e74c3c;color:#fff;padding:8px 12px;border-radius:6px;font-weight:700;">砖转 住</div>
        </div>
      `,
      customer: `
        <div style="margin-bottom:30px;">
          <div style="font-size:16px;font-weight:700;color:#2c3e50;margin-bottom:10px;text-transform:uppercase;"></div>
          <div style="background:#f8f9fa;padding:15px;border-radius:5px;border-left:4px solid #27ae60;">
            <strong>{{customer.name}}</strong><br/>
            {{#if customer.address}}{{customer.address}}<br/>{{customer.city}}, {{customer.state}} {{customer.postalCode}}<br/>{{/if}}
            {{#if customer.email}}: {{customer.email}}<br/>{{/if}}
            {{#if customer.phone}}驻: {{customer.phone}}{{/if}}
          </div>
        </div>
      `,
      items: `
        <table style="width:100%;border-collapse:collapse;margin-bottom:30px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);border-radius:5px;overflow:hidden;">
          <thead>
            <tr>
              <th style="background:#3498db;color:#fff;padding:15px 10px;text-align:right;">转专</th>
              <th style="background:#3498db;color:#fff;padding:15px 10px;text-align:center;">转</th>
              <th style="background:#3498db;color:#fff;padding:15px 10px;text-align:left;">专 壮</th>
              <th style="background:#3498db;color:#fff;padding:15px 10px;text-align:left;">住</th>
            </tr>
          </thead>
          <tbody>
            {{#each items}}
            <tr>
              <td style="padding:12px 10px;border-bottom:1px solid #ecf0f1;">{{description}}</td>
              <td style="padding:12px 10px;border-bottom:1px solid #ecf0f1;text-align:center;">{{quantity}}</td>
              <td style="padding:12px 10px;border-bottom:1px solid #ecf0f1;text-align:left;">{{formatCurrency rate ../currency}}</td>
              <td style="padding:12px 10px;border-bottom:1px solid #ecf0f1;text-align:left;">{{formatCurrency amount ../currency}}</td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      `,
      taxInfo: `
        {{#if taxRate}}
        <div style="background:#fff3cd;border:2px solid #ffc107;border-radius:6px;padding:15px;margin-bottom:20px;">
          <div style="font-weight:700;color:#856404;margin-bottom:8px;">注 住</div>
          <div>
            砖注专 住: {{taxRate}}% | 住 住: <strong>{{formatCurrency taxAmount currency}}</strong>
          </div>
        </div>
        {{/if}}
      `,
      totals: `
        <div style="display:flex;justify-content:flex-end;margin-bottom:30px;">
          <table style="min-width:300px;border-collapse:collapse;">
            <tr>
              <td style="padding:8px 15px;border-bottom:1px solid #ecf0f1;text-align:right;font-weight:700;color:#2c3e50;">住 :</td>
              <td style="padding:8px 15px;border-bottom:1px solid #ecf0f1;text-align:left;font-weight:700;">{{formatCurrency subtotal currency}}</td>
            </tr>
            {{#if taxRate}}
            <tr>
              <td style="padding:8px 15px;border-bottom:1px solid #ecf0f1;text-align:right;font-weight:700;color:#2c3e50;">住 ({{taxRate}}%):</td>
              <td style="padding:8px 15px;border-bottom:1px solid #ecf0f1;text-align:left;font-weight:700;">{{formatCurrency taxAmount currency}}</td>
            </tr>
            {{/if}}
            <tr>
              <td style="padding:8px 15px;background:#2c3e50;color:#fff;text-align:right;font-weight:700;">住":</td>
              <td style="padding:8px 15px;background:#2c3e50;color:#fff;text-align:left;font-weight:700;">{{formatCurrency total currency}}</td>
            </tr>
          </table>
        </div>
      `,
      notes: `
        {{#if notes}}
        <div style="margin-top:10px;">
          <div style="font-size:16px;font-weight:700;color:#2c3e50;margin-bottom:10px;">注专转</div>
          <div style="background:#fff3cd;border:1px solid #ffeaa7;border-radius:5px;padding:15px;color:#856404;">{{notes}}</div>
        </div>
        {{/if}}
      `,
      thanks: `
        <div style="text-align:center;margin-top:30px;font-size:16px;color:#27ae60;font-weight:700;">转 注 注住拽!</div>
      `,
      credit: `
        <div style="text-align:center;margin-top:14px;font-size:10px;color:#666;">祝   注'' BrainboxAI</div>
      `,
      exempt: `
        <div style="background:#e8f5e8;border:2px solid #27ae60;border-radius:6px;padding:15px;margin-bottom:20px;text-align:center;">
          <div style="font-weight:700;color:#27ae60;margin-bottom:8px;">注住拽 驻专 住</div>
          <div style="color:#2d5a2d;">拽  转住转 注住拽 驻专 住.   住 转 转拽转 住 转.</div>
        </div>
      `
    };

    const scaffold = (inner) => `<!DOCTYPE html>
<html lang=\"he\" dir=\"rtl\">\n<head>\n<meta charset=\"UTF-8\"/>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n<title>{{invoiceNumber}}</title>\n<style>body{font-family:'Arial',sans-serif;font-size:12px;line-height:1.4;color:#333;background:#fff}.container{max-width:800px;margin:0 auto;padding:40px 30px}</style>\n</head>\n<body>\n<div class=\"container\">\n${inner}\n<div style=\"text-align:center;margin-top:20px;font-size:10px;color:#666;\">爪专 转专 {{formatDate generatedDate 'DD/MM/YYYY HH:mm:ss'}}</div>\n</div>\n</body>\n</html>`;

    const canvasEl = document.getElementById('canvas');
    const codeEl = document.getElementById('code');

    function handleDragOver(e){ e.preventDefault(); canvasEl.classList.add('drag-over'); }
    function handleDrop(e){
      e.preventDefault(); canvasEl.classList.remove('drag-over');
      const type = e.dataTransfer.getData('text/plain');
      appendBlock(type);
      renderCode();
    }

    document.querySelectorAll('[draggable=true][data-block]').forEach(el => {
      el.addEventListener('dragstart', (ev) => {
        ev.dataTransfer.setData('text/plain', el.dataset.block);
      });
    });

    function appendBlock(type){
      if(!blockLibrary[type]) return;
      const wrapper = document.createElement('div');
      wrapper.className = 'block';
      wrapper.draggable = true;
      wrapper.innerHTML = `<div class="d-flex justify-content-between align-items-center mb-2"><strong>${labelOf(type)}</strong><div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary" onclick="moveUp(this)"><i class='bi bi-arrow-up'></i></button><button class="btn btn-outline-secondary" onclick="moveDown(this)"><i class='bi bi-arrow-down'></i></button><button class="btn btn-outline-danger" onclick="removeBlock(this)"><i class='bi bi-trash'></i></button></div></div><div class="block-body">${blockLibrary[type]}</div>`;
      canvasEl.appendChild(wrapper);
    }

    function labelOf(type){
      const map = { header:'转专转 + 驻专 注住拽', taxBadge:'转转 砖转 住', customer:'驻专 拽', items:'转 驻专', taxInfo:'注 住', totals:'住', notes:'注专转', thanks:'专转 转', credit:'拽专', exempt:'注转 驻专' };
      return map[type] || type;
    }

    function removeBlock(btn){ btn.closest('.block').remove(); renderCode(); }
    function moveUp(btn){ const el = btn.closest('.block'); const prev = el.previousElementSibling; if(prev) { el.parentNode.insertBefore(el, prev); renderCode(); } }
    function moveDown(btn){ const el = btn.closest('.block'); const next = el.nextElementSibling; if(next) { el.parentNode.insertBefore(next, el); renderCode(); } }

    function collectHtml(){
      const bodies = Array.from(canvasEl.querySelectorAll('.block-body')).map(x => x.innerHTML.trim());
      return scaffold(bodies.join('\n'));
    }

    function renderCode(){ codeEl.textContent = collectHtml(); }

    async function handleSave(){
      const name = document.getElementById('templateName').value.trim();
      if(!name){ alert('  砖 转转'); return; }
      const content = collectHtml();
      const res = await fetch(`/api/templates/${encodeURIComponent(name)}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content }) });
      const data = await res.json();
      if(!data.success){ alert(data.error || '砖专 砖'); return; }
      alert('转转 砖专 爪');
    }

    async function handlePreview(){
      const name = document.getElementById('templateName').value.trim() || 'receipt';
      // 转爪 拽 砖转砖转 -API 爪 
      const payload = { templateType: name, customer: { name: '拽 ' }, items: [{ description: '砖专转', quantity: 1, rate: 100, amount: 100 }], total: 100 };
      const r = await fetch('/api/preview', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const html = await r.text();
      const w = window.open('', '_blank'); w.document.write(html); w.document.close();
    }

    async function handleLoad(){
      const name = document.getElementById('templateName').value.trim();
      if(!name){ alert('  砖 转转'); return; }
      const res = await fetch(`/api/templates/${encodeURIComponent(name)}`);
      const data = await res.json();
      if(!data.success){ alert(data.error || '注 砖'); return; }
      // 注 拽  砖 HTML 
      canvasEl.innerHTML = '';
      const raw = document.createElement('div');
      raw.className = 'block';
      raw.innerHTML = `<div class="d-flex justify-content-between align-items-center mb-2"><strong>HTML 拽</strong><div class="btn-group btn-group-sm"><button class="btn btn-outline-danger" onclick="removeBlock(this)"><i class='bi bi-trash'></i></button></div></div><div class='block-body'>${escapeHtml(data.content)}</div>`;
      canvasEl.appendChild(raw);
      renderCode();
    }

    function handleExport(){
      const content = collectHtml();
      const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'template.html'; a.click();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str){
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>


